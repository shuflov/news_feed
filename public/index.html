<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>News Feed</title>
  <style></style>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="header">
    <h1>News Feed</h1>
    <button class="dark-mode-toggle" id="darkModeToggle">
      ðŸŒ™ Dark Mode
    </button>
  </div>

  <div id="stockChartContainer" class="stock-chart-container">
    <div class="stock-header">
      <h3>Market Watch</h3>
      <button id="toggleChartBtn" class="toggle-chart-btn">âˆ’</button>
    </div>
    <div id="stockChartContent" class="stock-chart-content">
      <div class="stock-buttons">
        <button class="stock-btn active" data-symbol="TSLA">TESLA</button>
        <button class="stock-btn" data-symbol="BTC-USD">BTC</button>
        <button class="stock-btn" data-symbol="TOY.TO">Spinmaster</button>
        <button class="stock-btn" data-symbol="^GSPC">S&P 500</button>
      </div>
      <div class="stock-info">
        <span id="currentPrice" class="current-price">--</span>
        <span id="priceChange" class="price-change">--</span>
      </div>
      <canvas id="stockChart"></canvas>
    </div>
  </div>

  <section class="feed-controls">
    <button id="refreshBtn" class="refresh-btn">Refresh Feed</button>
    <button id="manageSourcesBtn" class="manage-btn">Manage Sources</button>
  </section>

  <section id="sourcesPanel" class="sources-panel" style="display: none;">
    <div class="panel-header">
      <h2>Manage Sources</h2>
      <button id="closeSourcesBtn" class="close-btn">&times;</button>
    </div>
    
    <div class="add-source-section">
      <h3>Add New Source</h3>
      <form id="addForm">
        <input placeholder="Name" id="name" required>
        <input placeholder="URL" id="url" required>
        <select id="type" title="Select Source Type">
          <option value="rss">RSS</option>
        </select>
        <button type="submit">Add Source</button>
      </form>
    </div>

    <div class="sources-list-section">
      <h3>Current Sources</h3>
      <div id="sourcesList"></div>
    </div>
  </section>

  <section id="feed"></section>

  <script>
    // Dark mode toggle functionality
    const darkModeToggle = document.getElementById('darkModeToggle');
    const body = document.body;
    
    // Check for saved theme preference or default to system preference
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'dark') {
      body.classList.add('dark-mode');
      updateToggleButton(true);
    } else if (savedTheme === 'light') {
      body.classList.add('light-mode');
      updateToggleButton(false);
    } else {
      // Use system preference
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      updateToggleButton(prefersDark);
    }
    
    darkModeToggle.addEventListener('click', () => {
      const isDark = body.classList.toggle('dark-mode');
      body.classList.toggle('light-mode');
      
      // Save preference
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
      updateToggleButton(isDark);
    });
    
    function updateToggleButton(isDark) {
      darkModeToggle.textContent = isDark ? 'â˜€ï¸ Light Mode' : 'ðŸŒ™ Dark Mode';
    }

    async function loadFeed() {
      try {
        const res = await fetch('/api/feed');
        
        // Check if response is OK
        if (!res.ok) {
          throw new Error(`Server error: ${res.status}`);
        }
        
        // Check if response is actually JSON
        const contentType = res.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
          throw new Error('Server returned non-JSON response');
        }
        
        let articles = await res.json();
        // Shuffle articles for random order
        articles = articles.sort(() => Math.random() - 0.5);
        const container = document.getElementById('feed');
        container.innerHTML = '';
        
        if (articles.length === 0) {
          container.innerHTML = '<p>No articles yet. Add a source and wait for the cron job to fetch articles.</p>';
          return;
        }
        
        articles.forEach(a => {
          const div = document.createElement('div');
          div.className = 'article';
          div.innerHTML = `
  <h3><a href="${a.link}" target="_blank">${a.title}</a></h3>
  <p class="summary">${a.summary}</p>
  <div class="meta">
    <span>${new Date(a.published_at).toLocaleString()}</span>
    <span>${a.sourceName}</span>
  </div>
`;
          container.appendChild(div);
        });
      } catch (error) {
        console.error('Error loading feed:', error);
        document.getElementById('feed').innerHTML = 
          `<p style="color:red;">Error loading feed: ${error.message}</p>`;
      }
    }

    document.getElementById('addForm').addEventListener('submit', async e => {
      e.preventDefault();
      const name = document.getElementById('name').value;
      const url = document.getElementById('url').value;
      const type = document.getElementById('type').value;
      await fetch('/api/sources', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({name, url, type})
      });
      e.target.reset();
      loadSources(); // Refresh the sources list
      alert('Source added â€“ it will be fetched on the next schedule.');
    });

    // Manual refresh button
    document.getElementById('refreshBtn').addEventListener('click', () => {
      loadFeed();
    });

    // Sources panel management
    const sourcesPanel = document.getElementById('sourcesPanel');
    const manageSourcesBtn = document.getElementById('manageSourcesBtn');
    const closeSourcesBtn = document.getElementById('closeSourcesBtn');

    manageSourcesBtn.addEventListener('click', () => {
      sourcesPanel.style.display = 'block';
      loadSources();
    });

    closeSourcesBtn.addEventListener('click', () => {
      sourcesPanel.style.display = 'none';
    });

    async function loadSources() {
      try {
        const res = await fetch('/api/sources');
        const sources = await res.json();
        const container = document.getElementById('sourcesList');
        
        if (sources.length === 0) {
          container.innerHTML = '<p>No sources added yet.</p>';
          return;
        }
        
        container.innerHTML = sources.map(s => `
          <div class="source-item">
            <div class="source-info">
              <strong>${s.name}</strong>
              <span class="source-type">${s.type}</span>
              <span class="source-status ${s.enabled ? 'enabled' : 'disabled'}">${s.enabled ? 'Enabled' : 'Disabled'}</span>
            </div>
            <div class="source-actions">
              <button onclick="deleteSource(${s.id})" class="delete-btn">Delete</button>
            </div>
          </div>
        `).join('');
      } catch (error) {
        console.error('Error loading sources:', error);
        document.getElementById('sourcesList').innerHTML = 
          `<p style="color:red;">Error loading sources</p>`;
      }
    }

    window.deleteSource = async function(id) {
      if (!confirm('Are you sure you want to delete this source?')) return;
      
      try {
        // Note: You'll need to add a DELETE endpoint to server.js
        const res = await fetch(`/api/sources/${id}`, {
          method: 'DELETE'
        });
        
        if (res.ok) {
          loadSources();
        } else {
          alert('Failed to delete source');
        }
      } catch (error) {
        console.error('Error deleting source:', error);
        alert('Error deleting source');
      }
    };

    loadFeed();
    // Auto-refresh every minute
    setInterval(loadFeed, 60000);

    // Stock Chart Functionality
    let stockChart = null;
    let currentSymbol = 'TSLA';

    // Toggle chart visibility
    const stockChartContent = document.getElementById('stockChartContent');
    const toggleChartBtn = document.getElementById('toggleChartBtn');
    let isChartMinimized = false;

    toggleChartBtn.addEventListener('click', () => {
      isChartMinimized = !isChartMinimized;
      stockChartContent.style.display = isChartMinimized ? 'none' : 'block';
      toggleChartBtn.textContent = isChartMinimized ? '+' : 'âˆ’';
    });

    // Stock button click handlers
    document.querySelectorAll('.stock-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.stock-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentSymbol = btn.dataset.symbol;
        loadStockData(currentSymbol);
      });
    });

    async function loadStockData(symbol) {
      try {
        // Using Yahoo Finance proxy API
        const response = await fetch(`https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?interval=1d&range=1mo`);
        const data = await response.json();
        
        if (data.chart && data.chart.result && data.chart.result[0]) {
          const result = data.chart.result[0];
          const prices = result.indicators.quote[0].close;
          const timestamps = result.timestamp;
          const meta = result.meta;
          
          // Update current price and change
          const currentPrice = prices[prices.length - 1];
          const previousPrice = prices[prices.length - 2];
          const change = currentPrice - previousPrice;
          const changePercent = (change / previousPrice) * 100;
          
          document.getElementById('currentPrice').textContent = `$${currentPrice.toFixed(2)}`;
          const changeEl = document.getElementById('priceChange');
          changeEl.textContent = `${change >= 0 ? '+' : ''}${change.toFixed(2)} (${changePercent >= 0 ? '+' : ''}${changePercent.toFixed(2)}%)`;
          changeEl.className = `price-change ${change >= 0 ? 'positive' : 'negative'}`;
          
          // Prepare chart data
          const labels = timestamps.map(t => new Date(t * 1000).toLocaleDateString());
          
          // Destroy existing chart if any
          if (stockChart) {
            stockChart.destroy();
          }
          
          // Create new chart
          const ctx = document.getElementById('stockChart').getContext('2d');
          const isDark = document.body.classList.contains('dark-mode');
          
          stockChart = new Chart(ctx, {
            type: 'line',
            data: {
              labels: labels,
              datasets: [{
                label: symbol,
                data: prices,
                borderColor: change >= 0 ? '#28a745' : '#dc3545',
                backgroundColor: change >= 0 ? 'rgba(40, 167, 69, 0.1)' : 'rgba(220, 53, 69, 0.1)',
                borderWidth: 2,
                fill: true,
                tension: 0.4,
                pointRadius: 0,
                pointHoverRadius: 4
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  display: false
                },
                tooltip: {
                  mode: 'index',
                  intersect: false,
                  backgroundColor: isDark ? 'rgba(0, 0, 0, 0.8)' : 'rgba(255, 255, 255, 0.9)',
                  titleColor: isDark ? '#fff' : '#333',
                  bodyColor: isDark ? '#fff' : '#333',
                  borderColor: isDark ? '#444' : '#ddd',
                  borderWidth: 1
                }
              },
              scales: {
                x: {
                  display: false
                },
                y: {
                  display: true,
                  grid: {
                    color: isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
                  },
                  ticks: {
                    color: isDark ? '#ccc' : '#666'
                  }
                }
              },
              interaction: {
                mode: 'nearest',
                axis: 'x',
                intersect: false
              }
            }
          });
        }
      } catch (error) {
        console.error('Error loading stock data:', error);
        document.getElementById('currentPrice').textContent = 'Error';
        document.getElementById('priceChange').textContent = 'Failed to load';
      }
    }

    // Load initial stock data
    loadStockData(currentSymbol);

    // Refresh stock data every 5 minutes
    setInterval(() => loadStockData(currentSymbol), 300000);
  </script>
</body>
</html>