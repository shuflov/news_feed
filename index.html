<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>News Feed</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; line-height: 1.6; background: #f5f5f5; min-height: 100vh; }
    body.dark-mode { background: #1a1a1a; color: #e0e0e0; }
    body.dark-mode .header { background: #2a2a2a; }
    body.dark-mode .header h1 { color: #e0e0e0; }
    body.dark-mode .feed-controls { background: #2a2a2a; }
    body.dark-mode .sources-panel { background: #2a2a2a; }
    body.dark-mode .sources-panel h2, body.dark-mode .sources-panel h3 { color: #e0e0e0; }
    body.dark-mode input, body.dark-mode select { background: #3a3a3a; color: #e0e0e0; border-color: #555; }
    body.dark-mode .article { background: #2a2a2a; border-color: #444; }
    body.dark-mode .stock-card { background: #2a2a2a; }
    body.dark-mode .stock-card .stock-symbol { color: #aaa; }
    body.dark-mode .source-item { background: #333; }
    body.dark-mode .panel-header { background: #222; }
    body.dark-mode .stocks-container { background: #2a2a2a; }
    
    .auth-container { display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 1rem; }
    .auth-box { background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); max-width: 400px; width: 100%; }
    body.dark-mode .auth-box { background: #2a2a2a; }
    .auth-box h1 { text-align: center; margin-bottom: 1.5rem; }
    .auth-box input, .auth-box select { width: 100%; padding: 0.75rem; margin-bottom: 1rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem; }
    .auth-box button { width: 100%; padding: 0.75rem; background: #0066cc; color: white; border: none; border-radius: 4px; font-size: 1rem; cursor: pointer; margin-bottom: 0.5rem; }
    .auth-box button:hover { background: #0052a3; }
    .auth-box button.secondary { background: #666; }
    .auth-box button.secondary:hover { background: #555; }
    .auth-error { color: #cc0000; margin-bottom: 1rem; text-align: center; }
    body.dark-mode .auth-error { color: #ff6666; }
    .auth-switch { text-align: center; margin-top: 1rem; }
    .auth-switch a { color: #0066cc; cursor: pointer; }
    
    .app-container { display: none; }
    .app-container.active { display: block; }
    
    .header { background: white; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .header h1 { font-size: 1.5rem; }
    .header-right { display: flex; align-items: center; gap: 1rem; }
    
    .feed-controls { background: white; padding: 1rem 2rem; display: flex; gap: 1rem; flex-wrap: wrap; }
    .refresh-btn, .manage-btn, .logout-btn { padding: 0.5rem 1rem; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem; }
    .refresh-btn { background: #0066cc; color: white; }
    .manage-btn { background: #28a745; color: white; }
    .logout-btn { background: #dc3545; color: white; }
    
    .sources-panel { background: white; margin: 1rem 2rem; padding: 1.5rem; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
    .close-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; }
    .add-source-section { margin-bottom: 1.5rem; }
    .add-source-section h3 { margin-bottom: 0.5rem; }
    .add-source-section form { display: flex; gap: 0.5rem; flex-wrap: wrap; }
    .add-source-section input, .add-source-section select { flex: 1; min-width: 150px; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; }
    .add-source-section button { padding: 0.5rem 1rem; background: #0066cc; color: white; border: none; border-radius: 4px; cursor: pointer; }
    
    .sources-list-section h3 { margin-bottom: 0.5rem; }
    .source-item { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: #f9f9f9; border-radius: 4px; margin-bottom: 0.5rem; }
    .source-info { display: flex; align-items: center; gap: 0.5rem; }
    .source-type { background: #0066cc; color: white; padding: 0.2rem 0.5rem; border-radius: 3px; font-size: 0.75rem; }
    .source-status.enabled { color: #28a745; }
    .source-status.disabled { color: #dc3545; }
    .delete-btn { padding: 0.3rem 0.7rem; background: #dc3545; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 0.8rem; }
    
    .stocks-container { background: white; margin: 1rem 2rem; padding: 1rem; border-radius: 8px; }
    .stocks-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 1rem; }
    .stock-card { background: #f9f9f9; padding: 1rem; border-radius: 8px; text-align: center; }
    .stock-card .stock-symbol { color: #666; font-size: 0.9rem; margin-bottom: 0.5rem; }
    .stock-card .stock-price { font-size: 1.25rem; font-weight: bold; }
    .stock-card .stock-change { font-size: 0.85rem; margin-top: 0.25rem; }
    .stock-card .stock-change.positive { color: #28a745; }
    .stock-card .stock-change.negative { color: #dc3545; }
    .last-update { font-size: 0.75rem; color: #888; }
    .refresh-btn-sm { padding: 0.25rem 0.5rem; cursor: pointer; }
    
    #feed { padding: 1rem 2rem; }
    .article { background: white; padding: 1.5rem; margin-bottom: 1rem; border-radius: 8px; border-left: 4px solid #0066cc; }
    .article h3 { margin-bottom: 0.5rem; }
    .article h3 a { color: #0066cc; text-decoration: none; }
    .article h3 a:hover { text-decoration: underline; }
    .article .summary { color: #555; margin-bottom: 0.5rem; }
    .article .meta { font-size: 0.85rem; color: #888; }
    
    .dark-mode-toggle { padding: 0.5rem 1rem; cursor: pointer; }
  </style>
</head>
<body>
  <noscript>
    <div style="border: 2px solid #cc0000; padding: 1rem; margin: 1rem; background: #ffeeee;">
      <p><strong>JavaScript is required.</strong></p>
      <p>Please enable JavaScript in your browser.</p>
    </div>
  </noscript>

  <div id="authScreen" class="auth-container">
    <div class="auth-box">
      <h1 id="authTitle">Login</h1>
      <div id="authError" class="auth-error"></div>
      <form id="authForm">
        <input type="email" id="authEmail" placeholder="Email" required>
        <input type="password" id="authPassword" placeholder="Password" required>
        <button type="submit" id="authSubmit">Login</button>
      </form>
      <div class="auth-switch">
        <span id="authSwitchText">Don't have an account?</span>
        <a id="authSwitchLink"> Register</a>
      </div>
    </div>
  </div>

  <div id="appContainer" class="app-container">
    <div class="header">
      <h1>News Feed</h1>
      <div class="header-right">
        <span id="userEmail" style="font-size: 0.9em; color: #666;"></span>
        <button class="dark-mode-toggle" id="darkModeToggle">üåô Dark Mode</button>
        <button class="logout-btn" id="logoutBtn">Logout</button>
      </div>
    </div>

    <section class="feed-controls">
      <button id="refreshBtn" class="refresh-btn">Refresh Feed</button>
      <button id="manageSourcesBtn" class="manage-btn">Manage Sources</button>
    </section>

    <section id="sourcesPanel" class="sources-panel" style="display: none;">
      <div class="panel-header">
        <h2>Manage Sources</h2>
        <button id="closeSourcesBtn" class="close-btn">&times;</button>
      </div>
      
      <div class="add-source-section">
        <h3>Add New Source</h3>
        <form id="addForm">
          <input placeholder="Name" id="name" required>
          <input placeholder="URL" id="url" required>
          <select id="type">
            <option value="rss">RSS</option>
          </select>
          <button type="submit">Add Source</button>
        </form>
      </div>

      <div class="sources-list-section">
        <h3>Current Sources</h3>
        <div id="sourcesList"></div>
      </div>
    </section>

    <section id="stocksContainer" class="stocks-container">
      <div class="panel-header">
        <h2>Market Watch</h2>
        <button id="refreshStocksBtn" class="refresh-btn-sm" title="Refresh stocks">‚Üª</button>
        <span class="last-update" id="stocksLastUpdate">--</span>
      </div>
      <div class="stocks-grid" id="stocksGrid">
        <div class="stock-card loading">
          <div class="stock-symbol">Loading...</div>
        </div>
      </div>
    </section>

    <section id="feed"></section>
  </div>

  <script>
    const API_BASE = 'https://stealthier-amirah-duteously.ngrok-free.dev';

    let isLoginMode = true;

    function showAuthError(msg) {
      document.getElementById('authError').textContent = msg;
    }

    function clearAuthError() {
      document.getElementById('authError').textContent = '';
    }

    function switchAuthMode() {
      isLoginMode = !isLoginMode;
      document.getElementById('authTitle').textContent = isLoginMode ? 'Login' : 'Register';
      document.getElementById('authSubmit').textContent = isLoginMode ? 'Login' : 'Register';
      document.getElementById('authSwitchText').textContent = isLoginMode ? "Don't have an account?" : "Already have an account?";
      document.getElementById('authSwitchLink').textContent = isLoginMode ? " Register" : " Login";
      clearAuthError();
    }

    document.getElementById('authSwitchLink').addEventListener('click', switchAuthMode);

    document.getElementById('authForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      clearAuthError();
      
      const email = document.getElementById('authEmail').value;
      const password = document.getElementById('authPassword').value;
      const endpoint = isLoginMode ? `${API_BASE}/api/auth/login` : `${API_BASE}/api/auth/register`;
      
      try {
        const res = await fetch(endpoint, {
          method: 'POST',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });
        
        const data = await res.json();
        
        if (!res.ok) {
          throw new Error(data.error || 'Authentication failed');
        }
        
        currentUserEmail = data.email || '';
        document.getElementById('authForm').reset();
        showApp();
      } catch (err) {
        showAuthError(err.message);
      }
    });

    async function logout() {
      try {
        await fetch(`${API_BASE}/api/auth/logout`, { method: 'POST' });
      } catch (e) {}
      showAuth();
    }

    document.getElementById('logoutBtn').addEventListener('click', logout);

    let currentUserEmail = '';

    function showAuth() {
      document.getElementById('authScreen').style.display = 'flex';
      document.getElementById('appContainer').classList.remove('active');
    }

    function showApp() {
      document.getElementById('authScreen').style.display = 'none';
      document.getElementById('appContainer').classList.add('active');
      document.getElementById('userEmail').textContent = currentUserEmail;
      loadFeed();
      loadStocks();
    }

    async function checkAuth() {
      try {
        const res = await fetch(`${API_BASE}/api/auth/me`, { credentials: 'include' });
        if (res.ok) {
          const data = await res.json();
          currentUserEmail = data.email || '';
          showApp();
        } else {
          showAuth();
        }
      } catch (e) {
        showAuth();
      }
    }

    const darkModeToggle = document.getElementById('darkModeToggle');
    const body = document.body;
    
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'dark') {
      body.classList.add('dark-mode');
      updateToggleButton(true);
    } else if (savedTheme === 'light') {
      body.classList.add('light-mode');
      updateToggleButton(false);
    } else {
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      updateToggleButton(prefersDark);
    }
    
    darkModeToggle.addEventListener('click', () => {
      const isDark = body.classList.toggle('dark-mode');
      body.classList.toggle('light-mode');
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
      updateToggleButton(isDark);
    });
    
    function updateToggleButton(isDark) {
      darkModeToggle.textContent = isDark ? '‚òÄÔ∏è Light Mode' : 'üåô Dark Mode';
    }

    async function loadFeed() {
      try {
        const res = await fetch(`${API_BASE}/api/feed`, { credentials: 'include' });
        if (!res.ok) throw new Error(`Server error: ${res.status}`);
        
        const articles = await res.json();
        const container = document.getElementById('feed');
        container.innerHTML = '';
        
        if (articles.length === 0) {
          container.innerHTML = '<p>No articles yet. Add sources and click "Fetch Articles" to load them.</p>';
          return;
        }
        
        articles.sort(() => Math.random() - 0.5);
        
        articles.forEach(a => {
          const div = document.createElement('div');
          div.className = 'article';
          div.innerHTML = `
            <h3><a href="${a.link}" target="_blank">${a.title}</a></h3>
            <p class="summary">${a.summary || ''}</p>
            <div class="meta">
              <span class="meta-date">${new Date(a.published_at).toLocaleString()}</span>
              <span class="meta-source"> | ${a.sourceName}</span>
            </div>
          `;
          container.appendChild(div);
        });
      } catch (error) {
        console.error('Error loading feed:', error);
        document.getElementById('feed').innerHTML = `<p style="color:red;">Error loading feed: ${error.message}</p>`;
      }
    }

    document.getElementById('addForm').addEventListener('submit', async e => {
      e.preventDefault();
      const name = document.getElementById('name').value;
      const url = document.getElementById('url').value;
      const type = document.getElementById('type').value;
      
      try {
        const res = await fetch(`${API_BASE}/api/sources`, {
          method: 'POST',
          credentials: 'include',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({name, url, type})
        });
        
        if (!res.ok) {
          const err = await res.json();
          alert(err.error || 'Failed to add source');
        } else {
          e.target.reset();
          loadSources();
          alert('Source added! Click "Refresh Feed" to load articles.');
        }
      } catch (error) {
        alert('Error adding source');
      }
    });

    document.getElementById('refreshBtn').addEventListener('click', async () => {
      const btn = document.getElementById('refreshBtn');
      btn.disabled = true;
      btn.textContent = 'Fetching...';
      
      try {
        await fetch(`${API_BASE}/api/fetch`, { method: 'POST', credentials: 'include' });
        await loadFeed();
      } catch (error) {
        console.error('Error refreshing feed:', error);
      } finally {
        btn.disabled = false;
        btn.textContent = 'Refresh Feed';
      }
    });

    const sourcesPanel = document.getElementById('sourcesPanel');
    const manageSourcesBtn = document.getElementById('manageSourcesBtn');
    const closeSourcesBtn = document.getElementById('closeSourcesBtn');

    manageSourcesBtn.addEventListener('click', () => {
      sourcesPanel.style.display = 'block';
      loadSources();
    });

    closeSourcesBtn.addEventListener('click', () => {
      sourcesPanel.style.display = 'none';
    });

    async function loadSources() {
      try {
        const res = await fetch(`${API_BASE}/api/sources`, { credentials: 'include' });
        const sources = await res.json();
        const container = document.getElementById('sourcesList');
        
        if (sources.length === 0) {
          container.innerHTML = '<p>No sources added yet.</p>';
          return;
        }
        
        container.innerHTML = sources.map(s => `
          <div class="source-item">
            <div class="source-info">
              <strong>${s.name}</strong>
              <span class="source-type">${s.type}</span>
              <span class="source-status ${s.enabled ? 'enabled' : 'disabled'}">${s.enabled ? 'Enabled' : 'Disabled'}</span>
            </div>
            <div class="source-actions">
              <button onclick="deleteSource(${s.id})" class="delete-btn">Delete</button>
            </div>
          </div>
        `).join('');
      } catch (error) {
        console.error('Error loading sources:', error);
        document.getElementById('sourcesList').innerHTML = `<p style="color:red;">Error loading sources</p>`;
      }
    }

    window.deleteSource = async function(id) {
      if (!confirm('Delete this source?')) return;
      
      try {
        const res = await fetch(`${API_BASE}/api/sources/${id}`, {
          method: 'DELETE',
          credentials: 'include'
        });
        if (res.ok) loadSources();
        else alert('Failed to delete source');
      } catch (error) {
        alert('Error deleting source');
      }
    };

    const stockSymbols = {
      'TSLA': 'Tesla',
      'BTC-USD': 'Bitcoin',
      'TOY.TO': 'Spinmaster',
      '^GSPC': 'S&P 500'
    };

    async function loadStocks() {
      try {
        const response = await fetch(`${API_BASE}/api/stocks`);
        const stocks = await response.json();
        const grid = document.getElementById('stocksGrid');
        grid.innerHTML = '';
        
        stocks.forEach(stock => {
          const card = document.createElement('div');
          card.className = 'stock-card';
          const isPositive = stock.change >= 0;
          const displayName = stockSymbols[stock.symbol] || stock.symbol;
          
          if (stock.error) {
            card.innerHTML = `<div class="stock-symbol">${displayName}</div><div class="stock-price">--</div><div class="stock-change">Unavailable</div>`;
          } else {
            card.innerHTML = `
              <div class="stock-symbol">${displayName}</div>
              <div class="stock-price">$${stock.price.toFixed(2)}</div>
              <div class="stock-change ${isPositive ? 'positive' : 'negative'}">
                ${isPositive ? '+' : ''}${stock.change.toFixed(2)} (${isPositive ? '+' : ''}${stock.changePercent.toFixed(2)}%)
              </div>
            `;
          }
          grid.appendChild(card);
        });
        
        document.getElementById('stocksLastUpdate').textContent = 'Updated: ' + new Date().toLocaleTimeString();
      } catch (error) {
        console.error('Error loading stocks:', error);
        document.getElementById('stocksGrid').innerHTML = '<div class="stock-card error">Failed to load stocks</div>';
      }
    }

    document.getElementById('refreshStocksBtn').addEventListener('click', loadStocks);
    setInterval(loadStocks, 300000);

    checkAuth();
  </script>
</body>
</html>
